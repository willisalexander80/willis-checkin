<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Jobsite Daily Check-in</title>

  <!-- ─── CSS ─────────────────────────────────────────────────────────── -->
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#f5f6fa; color:#2c3e50; }
    .screen { display:none; }
    .screen.active { display:block; }

    /* ── Login Screen ─────────────────────────────────────────── */
    #login-screen { height:100vh; display:flex; align-items:center; justify-content:center; }
    .login-box {
      text-align:center; width:90%; max-width:460px;
      padding:32px; background:white; border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.1);
    }
    .scale-strip { display:flex; gap:8px; justify-content:center; margin-bottom:32px; }
    .scale-strip .bar { flex:1; height:8px; border-radius:4px; }
    .bar.red    { background:#e74c3c; }
    .bar.orange { background:#e67e22; }
    .bar.yellow { background:#f1c40f; }
    .bar.green  { background:#27ae60; }
    #login-screen input {
      width:100%; height:56px; padding:0 16px; font-size:18px;
      border:2px solid #ccc; border-radius:12px;
    }
    #login-screen button {
      margin-top:16px; width:100%; height:56px; font-size:18px;
      border:none; border-radius:12px; background:#1c90e4; color:white; cursor:pointer;
    }

    /* ── Shared Container ─────────────────────────────────────── */
    .container {
      max-width:500px; margin:0 auto; background:white; min-height:100vh;
      box-shadow:0 0 20px rgba(0,0,0,0.1);
    }

    /* ── Dashboard ───────────────────────────────────────────── */
    .dashboard-header {
      background:#2c3e50; color:white; padding:30px 20px; position:relative;
    }
    .dashboard-header button {
      position:absolute; top:20px; right:20px;
      background:white; color:#2c3e50; border:none; border-radius:6px;
      padding:8px 12px; cursor:pointer;
    }
    .welcome-text { font-size:28px; font-weight:600; margin-bottom:8px; }
    .dashboard-subtitle { font-size:18px; opacity:0.9; }
    .crew-info { font-size:16px; opacity:0.8; margin-top:4px; }
    .metrics-grid {
      display:grid; grid-template-columns:1fr 1fr; gap:20px; padding:20px;
    }
    .metric-card {
      background:white; padding:25px; border-radius:16px;
      text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }
    .metric-number { font-size:48px; font-weight:700; color:#2c3e50; }
    .metric-label  { font-size:16px; color:#7f8c8d; font-weight:500; }

    /* Team status & performance override */
    .team-status-card .metric-number, .team-status-card .metric-label,
    .performance-card .metric-number, .performance-card .metric-label {
      color:white;
    }
    .team-status-card.status-green  { background:#27ae60; }
    .team-status-card.status-yellow { background:#f1c40f; }
    .team-status-card.status-orange { background:#e67e22; }
    .team-status-card.status-red    { background:#e74c3c; }
    .performance-card.score-1 { background:#e74c3c; }
    .performance-card.score-2 { background:#e67e22; }
    .performance-card.score-3 { background:#f1c40f; }
    .performance-card.score-4 { background:#27ae60; }
    .performance-card.score-5 { background:#3498db; }
    .check-in-button {
      position:fixed; bottom:30px; left:50%;
      transform:translateX(-50%); width:calc(100% - 40px);
      max-width:460px; padding:16px; background:#3498db; color:white;
      border:none; border-radius:12px; font-size:18px; font-weight:600;
      cursor:pointer; box-shadow:0 4px 20px rgba(0,0,0,0.2);
    }
    .check-in-button:active { background:#2980b9; transform:translateX(-50%) scale(0.98); }

    /* ── Check-in Form ───────────────────────────────────────── */
    .header {
      background:#2c3e50; color:white; padding:20px; text-align:center; position:relative;
    }
    .header .back-button {
      position:absolute; top:20px; left:20px;
      background:rgba(255,255,255,0.2); border:none; border-radius:50%;
      width:36px; height:36px; color:white; font-size:20px; cursor:pointer;
    }
    .form-section { padding:20px; }
    .section-title {
      font-size:18px; font-weight:600; color:#2c3e50;
      margin-bottom:20px; border-bottom:2px solid #e9ecef;
      display:flex; justify-content:space-between; align-items:center;
    }
    .performance-score-display {
      padding:8px 16px; border-radius:8px; font-size:20px; font-weight:700; color:white;
    }
    .performance-score-display.score-1 { background:#e74c3c; }
    .performance-score-display.score-2 { background:#e67e22; }
    .performance-score-display.score-3 { background:#f1c40f; }
    .performance-score-display.score-4 { background:#27ae60; }
    .performance-score-display.score-5 { background:#3498db; }

    .metric-group { margin-bottom:30px; }
    .metric-label { font-size:16px; font-weight:500; color:#495057; margin-bottom:12px; }

    .button-scale {
      display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-bottom:5px;
    }
    .scale-button {
      height:60px; border:2px solid transparent; border-radius:12px;
      font-size:14px; font-weight:600; color:white; cursor:pointer;
      display:flex; align-items:center; justify-content:center; transition:all .2s;
      text-shadow:0 1px 2px rgba(0,0,0,0.2);
    }
    .scale-button.selected {
      border-color:#2c3e50; box-shadow:0 0 0 3px rgba(44,62,80,0.2);
    }
    .scale-button.scale-1 { background:#e74c3c; }
    .scale-button.scale-2 { background:#e67e22; }
    .scale-button.scale-3 { background:#f1c40f; }
    .scale-button.scale-4 { background:#27ae60; }
    .scale-button.scale-5 { background:#3498db; }

    .status-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px; }
    .status-button {
      height:80px; border:3px solid transparent; border-radius:16px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:5px; font-size:16px; font-weight:600; cursor:pointer; color:white;
      text-shadow:0 1px 2px rgba(0,0,0,0.2); transition:all .2s;
    }
    .status-button.selected {
      border-color:#2c3e50; box-shadow:0 0 0 4px rgba(44,62,80,0.2);
    }
    .status-button.status-green  { background:#27ae60; }
    .status-button.status-yellow { background:#f1c40f; }
    .status-button.status-orange { background:#e67e22; }
    .status-button.status-red    { background:#e74c3c; }

    .follow-up {
      background:#f8f9fa; border-left:4px solid #3498db;
      border-radius:12px; padding:15px; margin-top:12px; display:none;
    }
    .follow-up.show { display:block; }
    .option-chip {
      padding:8px 16px; background:white; border:2px solid #dee2e6;
      border-radius:20px; display:inline-flex; align-items:center; gap:6px;
      cursor:pointer; transition:all .2s;
    }
    .option-chip.selected {
      background:#3498db; color:white; border-color:#3498db;
    }

    .comments-box {
      width:100%; min-height:80px; padding:12px;
      border:2px solid #dee2e6; border-radius:8px; resize:vertical;
    }
    .submit-section {
      padding:20px; background:#f8f9fa; border-top:1px solid #dee2e6; position:sticky; bottom:0;
    }
    .submit-button {
      width:100%; padding:16px; background:#3498db; color:white;
      border:none; border-radius:12px; font-size:18px; font-weight:600; cursor:pointer;
      transition:all .2s;
    }
    .submit-button:active { background:#2980b9; }
    .progress-bar { height:4px; background:#e9ecef; overflow:hidden; margin-bottom:20px; }
    .progress-fill { height:100%; background:#3498db; transition:width .3s; }
  </style>

  <!-- ─── Supabase SDK ─────────────────────────────────────────────────────────── -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ─── Initialize Supabase client ─────────────────────────────────────────────
    const SUPABASE_URL = 'https://atmcmhmuxgldajwlwtga.supabase.co';
    const SUPABASE_KEY = 'YOUR_ANON_KEY_HERE';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ─── Toggle screens ─────────────────────────────────────────────────────────
    function toggleScreens(isLoggedIn) {
      document.getElementById('login-screen').classList.toggle('active', !isLoggedIn);
      document.getElementById('dashboard-screen').classList.toggle('active',  isLoggedIn);
    }

    // ─── Handle magic-link callback & clean URL ─────────────────────────────────
    async function handleMagicLink() {
      if (window.location.hash.includes('access_token') || window.location.hash.includes('error')) {
        const { error } = await supabase.auth.getSessionFromUrl({ storeSession: true });
        if (error) console.error('Magic-link error:', error.message);
        history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // ─── On auth changes ────────────────────────────────────────────────────────
    supabase.auth.onAuthStateChange(async (_event, session) => {
      const loggedIn = !!session;
      toggleScreens(loggedIn);
      if (loggedIn) {
        await loadProfile();
        await refreshDashboard();
      }
    });

    // ─── Initial page load ─────────────────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', async () => {
      await handleMagicLink();
      const { data: { session } } = await supabase.auth.getSession();
      toggleScreens(!!session);
      if (session) {
        await loadProfile();
        await refreshDashboard();
      }
    });
  </script>
</head>

<body>
  <!-- ─── LOGIN SCREEN ─────────────────────────────────────────────── -->
  <div id="login-screen" class="screen active">
    <div class="login-box">
      <div class="scale-strip">
        <span class="bar red"></span>
        <span class="bar orange"></span>
        <span class="bar yellow"></span>
        <span class="bar green"></span>
      </div>
      <h1>Jobsite Daily Check-in</h1>
      <p>Sign in with your company e-mail to continue</p>
      <input id="email-input" type="email" placeholder="you@company.com" />
      <button onclick="sendMagicLink()">Send magic link</button>
    </div>
  </div>

  <!-- ─── DASHBOARD SCREEN ───────────────────────────────────────── -->
  <div id="dashboard-screen" class="screen">
    <div class="container">
      <div class="dashboard-header">
        <h1 class="welcome-text">Welcome back, —</h1>
        <button onclick="logout()">Log out</button>
        <div class="dashboard-subtitle">Jobsite Dashboard</div>
        <div class="crew-info">Crew: — | Project: —</div>
      </div>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-number" id="total-checkins">0</div>
          <div class="metric-label">Total Check-ins</div>
        </div>
        <div class="metric-card team-status-card" id="team-status-card">
          <div class="metric-number team-status-emoji" id="team-status-emoji">—</div>
          <div class="team-status-text" id="team-status-text">No Check-in</div>
          <div class="metric-label">Today's Team Status</div>
        </div>
        <div class="metric-card">
          <div class="metric-number" id="green-days">0</div>
          <div class="metric-label">Team Green Days</div>
        </div>
        <div class="metric-card performance-card score-3" id="performance-card">
          <div class="metric-number" id="performance-score">3.0</div>
          <div class="metric-label">Project Performance Score</div>
        </div>
      </div>
      <button class="check-in-button" onclick="showCheckinForm()">
        Start Daily Check-in
      </button>
    </div>
  </div>

  <!-- ─── CHECK-IN FORM SCREEN ─────────────────────────────────────── -->
  <div id="checkin-screen" class="screen">
    <div class="container">
      <div class="header">
        <button class="back-button" onclick="showDashboard()">←</button>
        <h1>WILLIS Daily Check-in</h1>
        <p>2.5-minute leadership effectiveness tracker</p>
      </div>
      <div class="form-section">
        <div class="progress-bar">
          <div class="progress-fill" style="width:0%"></div>
        </div>

        <!-- Team Status -->
        <h2 class="section-title">👥 Team Status</h2>
        <div class="metric-group">
          <label class="metric-label">How's your crew today?</label>
          <div class="status-grid">
            <button class="status-button status-green" onclick="selectStatus(this,'green')">
              <span class="emoji">💪</span><span>Energized</span>
            </button>
            <button class="status-button status-yellow" onclick="selectStatus(this,'yellow')">
              <span class="emoji">👍</span><span>Managing OK</span>
            </button>
            <button class="status-button status-orange" onclick="selectStatus(this,'orange')">
              <span class="emoji">😐</span><span>Some Struggle</span>
            </button>
            <button class="status-button status-red" onclick="selectStatus(this,'red')">
              <span class="emoji">🆘</span><span>Need Support</span>
            </button>
          </div>
          <div id="team-followup" class="follow-up">
            <label class="follow-up-label">🎯 What’s affecting your team?</label>
            <div>
              <span class="option-chip" onclick="selectChip(this)">💪 Physical</span>
              <span class="option-chip" onclick="selectChip(this)">🧠 Mental</span>
              <span class="option-chip" onclick="selectChip(this)">❤️ Emotional</span>
              <span class="option-chip" onclick="selectChip(this)">🤝 Team</span>
              <span class="option-chip" onclick="selectChip(this)">🎯 Purpose</span>
            </div>
          </div>
        </div>
        <div class="comments-section">
          <textarea id="team-comments" class="comments-box" placeholder="Any team observations…"></textarea>
        </div>

        <!-- Project Status -->
        <h2 class="section-title">
          📊 Project Status
          <span id="live-performance-score" class="performance-score-display score-3">3.0</span>
        </h2>
        <!-- Productivity -->
        <div class="metric-group">
          <label class="metric-label">Productivity vs expectations?</label>
          <div class="button-scale">
            <button class="scale-button scale-1" onclick="selectScale(this,'prod',1)">1</button>
            <button class="scale-button scale-2" onclick="selectScale(this,'prod',2)">2</button>
            <button class="scale-button scale-3 selected" onclick="selectScale(this,'prod',3)">3</button>
            <button class="scale-button scale-4" onclick="selectScale(this,'prod',4)">4</button>
            <button class="scale-button scale-5" onclick="selectScale(this,'prod',5)">5</button>
          </div>
          <div id="prod-followup" class="follow-up">
            <label class="follow-up-label">📉 What slowed you down?</label>
            <div>
              <span class="option-chip" onclick="selectChip(this)">📦 Materials</span>
              <span class="option-chip" onclick="selectChip(this)">🌧️ Weather</span>
              <span class="option-chip" onclick="selectChip(this)">🔧 Equipment</span>
              <span class="option-chip" onclick="selectChip(this)">🤝 Coordination</span>
              <span class="option-chip" onclick="selectChip(this)">📋 Permits</span>
              <span class="option-chip" onclick="selectChip(this)">👷 Manpower</span>
            </div>
          </div>
        </div>

        <!-- Clarity -->
        <div class="metric-group">
          <label class="metric-label">Flow from morning briefing?</label>
          <div class="button-scale">
            <button class="scale-button scale-1" onclick="selectScale(this,'clarity',1)">1</button>
            <button class="scale-button scale-2" onclick="selectScale(this,'clarity',2)">2</button>
            <button class="scale-button scale-3 selected" onclick="selectScale(this,'clarity',3)">3</button>
            <button class="scale-button scale-4" onclick="selectScale(this,'clarity',4)">4</button>
            <button class="scale-button scale-5" onclick="selectScale(this,'clarity',5)">5</button>
          </div>
          <div id="clarity-followup" class="follow-up">
            <label class="follow-up-label">💭 What would improve it?</label>
            <div>
              <span class="option-chip" onclick="selectChip(this)">📊 Visuals</span>
              <span class="option-chip" onclick="selectChip(this)">⏰ Time</span>
              <span class="option-chip" onclick="selectChip(this)">📐 Drawings</span>
              <span class="option-chip" onclick="selectChip(this)">❓ Q&A</span>
              <span class="option-chip" onclick="selectChip(this)">🔄 Sequence</span>
            </div>
          </div>
        </div>

        <!-- Resolution -->
        <div class="metric-group">
          <label class="metric-label">Issue resolution speed?</label>
          <div class="button-scale">
            <button class="scale-button scale-1" onclick="selectScale(this,'resolve',1)">1</button>
            <button class="scale-button scale-2" onclick="selectScale(this,'resolve',2)">2</button>
            <button class="scale-button scale-3 selected" onclick="selectScale(this,'resolve',3)">3</button>
            <button class="scale-button scale-4" onclick="selectScale(this,'resolve',4)">4</button>
            <button class="scale-button scale-5" onclick="selectScale(this,'resolve',5)">5</button>
          </div>
          <div id="resolve-followup" class="follow-up">
            <label class="follow-up-label">⏱️ What slowed response?</label>
            <div>
              <span class="option-chip" onclick="selectChip(this)">📱 Decision</span>
              <span class="option-chip" onclick="selectChip(this)">🔍 Unclear</span>
              <span class="option-chip" onclick="selectChip(this)">🚫 Authority</span>
              <span class="option-chip" onclick="selectChip(this)">⏳ Waiting</span>
            </div>
          </div>
        </div>

        <!-- Safety -->
        <div class="metric-group">
          <label class="metric-label">Safety engagement?</label>
          <div class="button-scale">
            <button class="scale-button scale-1" onclick="selectScale(this,'safety',1)">1</button>
            <button class="scale-button scale-2" onclick="selectScale(this,'safety',2)">2</button>
            <button class="scale-button scale-3 selected" onclick="selectScale(this,'safety',3)">3</button>
            <button class="scale-button scale-4" onclick="selectScale(this,'safety',4)">4</button>
            <button class="scale-button scale-5" onclick="selectScale(this,'safety',5)">5</button>
          </div>
          <div id="safety-followup" class="follow-up">
            <label class="follow-up-label">⚠️ What prevented more?</label>
            <div>
              <span class="option-chip" onclick="selectChip(this)">⏰ Time</span>
              <span class="option-chip" onclick="selectChip(this)">🔥 Priorities</span>
              <span class="option-chip" onclick="selectChip(this)">✅ No issues</span>
              <span class="option-chip" onclick="selectChip(this)">😴 Fatigue</span>
            </div>
          </div>
        </div>

        <div class="comments-section">
          <textarea id="project-comments" class="comments-box" placeholder="Observations…"></textarea>
        </div>
        <div class="submit-section">
          <button class="submit-button" onclick="submitCheckin()">Submit Daily Check-in</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ─── All JavaScript ─────────────────────────────────────────────────── -->
  <script>
    // ─── AUTH HELPERS ──────────────────────────────────────────────────────
    async function sendMagicLink() {
      const email = document.getElementById('email-input').value.trim();
      if (!email) {
        alert('Please enter your work e-mail');
        return;
      }
      const { error } = await supabase.auth.signInWithOtp({ email });
      if (error) alert(error.message);
      else       alert('✅ Check your inbox for the magic link.');
    }

    async function logout() {
      await supabase.auth.signOut();
    }

    // ─── PROFILE + DASHBOARD ───────────────────────────────────────────────
    async function loadProfile() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      let { data, error } = await supabase
        .from('profiles')
        .select('full_name, crew, project')
        .eq('id', user.id)
        .single();

      if (error && error.code === 'PGRST116') {
        await supabase.from('profiles').insert({
          id: user.id,
          full_name: user.email,
          crew: null,
          project: null
        });
        data = { full_name: user.email, crew: null, project: null };
      }

      document.querySelector('.welcome-text').textContent =
        `Welcome back, ${data.full_name}`;
      document.querySelector('.crew-info').textContent =
        `Crew: ${data.crew || '—'} | Project: ${data.project || '—'}`;
    }

    // ─── STATE ─────────────────────────────────────────────────────────────
    let projectScores = { prod:3, clarity:3, resolve:3, safety:3 };
    let dashboardData  = { todayStatus:null, todayStatusText:null, todayStatusEmoji:null };

    function calculatePerformanceScore() {
      const s =
        0.35*projectScores.prod +
        0.25*projectScores.clarity +
        0.20*projectScores.resolve +
        0.20*projectScores.safety;
      return Math.min(5, Math.max(1, s));
    }

    // ─── DASHBOARD UI ─────────────────────────────────────────────────────
    async function refreshDashboard() {
      const { data, error } = await supabase.from('checkins').select('*');
      if (error) return console.error(error);

      // totals
      document.getElementById('total-checkins').textContent = data.length;
      document.getElementById('green-days').textContent = data.filter(r=>r.team_status==='green').length;

      // last check-in
      const last = data.at(-1);
      if (last) {
        dashboardData.todayStatus      = last.team_status;
        dashboardData.todayStatusText  = {
          green:'Energized', yellow:'Managing OK',
          orange:'Some Struggle', red:'Need Support'
        }[last.team_status];
        dashboardData.todayStatusEmoji = {
          green:'💪', yellow:'👍', orange:'😐', red:'🆘'
        }[last.team_status];
        projectScores = {
          prod: last.prod,
          clarity: last.clarity,
          resolve: last.resolve,
          safety: last.safety
        };
      }

      // update cards
      const tsCard = document.getElementById('team-status-card');
      tsCard.classList.remove('status-green','status-yellow','status-orange','status-red');
      tsCard.classList.add(`status-${dashboardData.todayStatus || 'yellow'}`);
      document.getElementById('team-status-text').textContent = dashboardData.todayStatusText || 'No Check-in';
      document.getElementById('team-status-emoji').textContent = dashboardData.todayStatusEmoji || '—';

      const score = calculatePerformanceScore();
      const perfCard = document.getElementById('performance-card');
      document.getElementById('performance-score').textContent = score.toFixed(1);
      perfCard.classList.remove('score-1','score-2','score-3','score-4','score-5');
      perfCard.classList.add(`score-${Math.round(score)}`);
    }

    // ─── CHECK-IN FORM ────────────────────────────────────────────────────
    function showCheckinForm() {
      document.getElementById('dashboard-screen').classList.remove('active');
      document.getElementById('checkin-screen'  ).classList.add('active');
      updateLiveScore();
    }
    function showDashboard() {
      document.getElementById('checkin-screen'  ).classList.remove('active');
      document.getElementById('dashboard-screen').classList.add('active');
    }

    function selectStatus(btn, status) {
      btn.closest('.status-grid').querySelectorAll('.status-button')
         .forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      dashboardData.todayStatus = status;
      dashboardData.todayStatusText  = {
        green:'Energized', yellow:'Managing OK',
        orange:'Some Struggle', red:'Need Support'
      }[status];
      dashboardData.todayStatusEmoji = {
        green:'💪', yellow:'👍', orange:'😐', red:'🆘'
      }[status];
      document.getElementById('team-followup').classList.toggle('show', status==='orange'||status==='red');
      updateProgress();
    }

    function selectScale(btn, metric, value) {
      btn.closest('.button-scale').querySelectorAll('.scale-button')
         .forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      projectScores[metric] = value;
      updateLiveScore();
      const f = document.getElementById(`${metric}-followup`);
      if ((metric==='prod' && (value<=2||value>=4)) || (metric!=='prod'&&value<=2)) {
        f.classList.add('show');
      } else {
        f.classList.remove('show');
      }
      updateProgress();
    }

    function selectChip(el) { el.classList.toggle('selected'); }

    function updateLiveScore() {
      const score = calculatePerformanceScore();
      const el = document.getElementById('live-performance-score');
      el.textContent = score.toFixed(1);
      el.className = `performance-score-display score-${Math.round(score)}`;
    }

    function updateProgress() {
      const total = 5; // 1 status + 4 scales
      const answered = document.querySelectorAll('.status-button.selected, .scale-button.selected').length;
      document.querySelector('.progress-fill').style.width = `${(answered/total)*100}%`;
    }

    async function submitCheckin() {
      const { data:{ user } } = await supabase.auth.getUser();
      if (!user) return alert('You must be signed in.');

      const payload = {
        user_id: user.id,
        team_status: dashboardData.todayStatus,
        team_tags:   Array.from(document.querySelectorAll('#team-followup .option-chip.selected')).map(c=>c.textContent),
        team_comment: document.getElementById('team-comments').value,
        prod:    projectScores.prod,
        clarity: projectScores.clarity,
        resolve: projectScores.resolve,
        safety:  projectScores.safety,
        prod_tags:    Array.from(document.querySelectorAll('#prod-followup .option-chip.selected')).map(c=>c.textContent),
        clarity_tags: Array.from(document.querySelectorAll('#clarity-followup .option-chip.selected')).map(c=>c.textContent),
        resolve_tags: Array.from(document.querySelectorAll('#resolve-followup .option-chip.selected')).map(c=>c.textContent),
        safety_tags:  Array.from(document.querySelectorAll('#safety-followup .option-chip.selected')).map(c=>c.textContent),
        project_comment: document.getElementById('project-comments').value
      };

      const { error } = await supabase.from('checkins').insert(payload);
      if (error) return alert('Error saving check-in:\n' + error.message);

      await refreshDashboard();
      showDashboard();
      resetForm();
    }

    function resetForm() {
      projectScores = { prod:3, clarity:3, resolve:3, safety:3 };
      document.querySelectorAll('.follow-up').forEach(d=>d.classList.remove('show'));
      document.querySelectorAll('.option-chip.selected').forEach(c=>c.classList.remove('selected'));
      document.querySelectorAll('textarea').forEach(t=>t.value='');
      document.querySelectorAll('.status-button, .scale-button').forEach(b=>b.classList.remove('selected'));
      updateProgress();
    }
  </script>
</body>
</html>
